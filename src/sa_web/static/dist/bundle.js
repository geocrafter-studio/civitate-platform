var Shareabouts=Shareabouts||{};!function(e){Handlebars.registerHelper("STATIC_URL",function(){return e.bootstrapped.staticUrl}),Handlebars.registerHelper("debug",function(e){return typeof e==typeof{}?JSON.stringify(e,null,4):e}),Handlebars.registerHelper("current_url",function(){return window.location.toString()}),Handlebars.registerHelper("permalink",function(){return window.location.toString()}),Handlebars.registerHelper("is",function(e,t,i){return e===t?i.fn(this):i.inverse(this)}),Handlebars.registerHelper("if_fileinput_not_supported",function(t){return e.Util.fileInputSupported()?null:t.fn(this)}),Handlebars.registerHelper("if_not_authenticated",function(t){return e.bootstrapped&&e.bootstrapped.currentUser?t.inverse(this):t.fn(this)}),Handlebars.registerHelper("property",function(e,t){return e[t]}),Handlebars.registerHelper("is_authenticated",function(t){return e.bootstrapped&&e.bootstrapped.currentUser?t.fn(this):t.inverse(this)}),Handlebars.registerHelper("current_user",function(t){return e.bootstrapped.currentUser?e.bootstrapped.currentUser[t]:void 0}),Handlebars.registerHelper("formatdatetime",function(e,t){return e?moment(e).format(t):e}),Handlebars.registerHelper("fromnow",function(e){return e?moment(e).fromNow():""}),Handlebars.registerHelper("truncatechars",function(e,t,i){return(_.isUndefined(i)||!_.isString(i))&&(i="..."),e&&e.length>t?e.slice(0,t-i.length)+i:e}),Handlebars.registerHelper("is_submitter_name",function(e){return"submitter_name"===this.name?e.fn(this):e.inverse(this)}),Handlebars.registerHelper("action_text",function(){return e.Config.place.action_text||""}),Handlebars.registerHelper("place_type_label",function(t){var i=e.Config.placeTypes[t];return i?i.label||t:""}),Handlebars.registerHelper("anonymous_name",function(){return e.Config.place.anonymous_name}),Handlebars.registerHelper("survey_label_by_count",function(){var t,i=0;return this.submission_sets&&this.submission_sets[e.Config.survey.submission_type]&&(t=this.submission_sets[e.Config.survey.submission_type],i=t?t.length:0),1===i?e.Config.survey.response_name:e.Config.survey.response_plural_name}),Handlebars.registerHelper("survey_label",function(){return e.Config.survey.response_name}),Handlebars.registerHelper("survey_label_plural",function(){return e.Config.survey.response_plural_name}),Handlebars.registerHelper("support_label",function(){return e.Config.support.response_name}),Handlebars.registerHelper("support_label_plural",function(){return e.Config.support.response_plural_name}),Handlebars.registerHelper("survey_count",function(){var t,i=0;return this.submission_sets&&this.submission_sets[e.Config.survey.submission_type]&&(t=this.submission_sets[e.Config.survey.submission_type],i=t?t.length:0),i}),Handlebars.registerHelper("get_value",function(e,t){return e[t]}),Handlebars.registerHelper("select_item_value",function(e,t,i){var s=e[t],o=$("<div/>").html(i.fn(this)),n=function(e){o.find('[value="'+e+'"]').attr({checked:"checked",selected:"selected"})};return $.isArray(s)?jQuery.each(s,function(e,t){n(t)}):n(s),o.html()}),Handlebars.registerHelper("contains",function(e,t,i){return t=t instanceof Array?t:[t],t.indexOf(e)>-1?i.fn(this):""}),Handlebars.registerHelper("each_place_item",function(){var t,i,s=this,o="",n=Array.prototype.slice.call(arguments),a=_.find(e.Config.place.place_detail,function(e){return e.category===s.location_type})||{};return i=n.slice(-1)[0],t=n.slice(0,n.length-1),_.each(a.fields,function(e){var n,a=s[e.name],r=e.type,l=!1;"text"===r||"textarea"===r||"datetime"===r?(n=a||"",""!==n&&(l=!0)):"checkbox_big_buttons"===r||"radio_big_buttons"===r||"dropdown"===r?($.isArray(s[e.name])||(a=[s[e.name]]),n=[],_.each(e.content,function(e){var t=!1;_.contains(a,e.value)&&(t=!0,l=!0),n.push({value:e.value,label:e.label,selected:t})})):"binary_toggle"===r&&(n={selectedValue:e.content[0].value,selectedLabel:e.content[0].label,unselectedValue:e.content[1].value,unselectedLabel:e.content[1].label,selected:a==e.content[0].value?!0:!1},l=!0);var c={name:e.name,type:e.type,content:n,prompt:e.display_prompt,wasAnswered:l,isEditingToggled:this.isEditingToggled};_.contains(t,e.name)===!1&&0!==e.name.indexOf("private-")&&void 0!=c.content&&c.wasAnswered===!0&&(o+=i.fn(c))},this),o}),Handlebars.registerHelper("place_url",function(e){var t=window.location,i=t.protocol,s=t.host;return[i,"//",s,"/place/",e].join("")})}(Shareabouts);var Shareabouts=Shareabouts||{};!function(e,t){"use strict";var i=function(e,t,i){var s;return null===e||_.isObject(e)?(s=e,i=t):null!==e&&((s={})[e]=t),i=i?_.clone(i):{},{options:i,attrs:s}},s=function(t,i){var s,o=null;return"place"===i?s=t.properties.datasetSlug+"/"+t.properties.id:"landmark"===i&&(s=t.title),_.each(e.Config.story,function(e){e.order[s]&&(o={tagline:e.tagline,next:e.order[s].next,previous:e.order[s].previous,zoom:e.order[s].zoom,panTo:e.order[s].panTo,visibleLayers:e.order[s].visibleLayers,basemap:e.order[s].basemap,spotlight:e.order[s].spotlight})}),{story:o}},o=function(e){var t,i=/^\s*<(h[0-9]|b)>(.+)<(\/h[0-9]|\/b)>/,s=e.description.match(i);return s?(t=s[2],e.originalDescription=e.description,e.description=e.description.replace(i,"")):t=e.title,{fullTitle:t}};e.PaginatedCollection=Backbone.Collection.extend({resultsAttr:"results",parse:function(e,t){if(t.attributesToAdd)for(var i=0;i<e[this.resultsAttr].length;i++)_.extend(e[this.resultsAttr][i][t.attribute],t.attributesToAdd);return this.metadata=e.metadata,e[this.resultsAttr]},fetchNextPage:function(e,t){var i=this;this.metadata.next&&i.fetch({remove:!1,url:i.metadata.next,success:e,error:t})},fetchAllPages:function(e){var t,i,s,o,n,a,r=this,l=0,c=1;e=e||{},e.data=e.data||{},e.error&&(a=_.once(e.error)),t=function(t,a){var l,p=a[r.resultsAttr].length;if(c=Math.ceil(a.metadata.length/p),e.success&&(n=_.after(c,e.success)),a.metadata.next)for(l=2;c>=l;l++)r.fetch(_.defaults({remove:!1,data:_.defaults({page:l},e.data),complete:i,success:s,error:o},e));s.apply(this,arguments)},i=function(){l++,e.pageComplete&&e.pageComplete.apply(this,arguments),l===c&&e.complete&&e.complete.apply(this,arguments)},s=function(){e.pageSuccess&&e.pageSuccess.apply(this,arguments),n&&n.apply(this,arguments)},o=function(){e.pageError&&e.pageError.apply(this,arguments),a&&a.apply(this,arguments)},this.fetch(_.defaults({success:t,error:o,complete:i},e))}}),e.SubmissionCollection=e.PaginatedCollection.extend({initialize:function(e,t){this.options=t},url:function(){var e=this.options.submissionType,t=this.options.placeModel&&this.options.placeModel.id,i=this.options.placeModel&&this.options.placeModel.get("datasetId");if(!e)throw new Error("submissionType option is required.");if(!t)throw new Error("Place model id is not defined. You must save the place before saving its "+e+".");return"/dataset/"+i+"/places/"+t+"/"+e},comparator:"created_datetime"}),e.PlaceModel=Backbone.Model.extend({initialize:function(){var t;this.submissionSets={},_.each(this.get("submission_sets"),function(t,i){var s=[];_.isArray(t)&&(s=t),this.submissionSets[i]=new e.SubmissionCollection(s,{submissionType:i,placeModel:this})},this),t=this.get("attachments")||[],this.attachmentCollection=new e.AttachmentCollection(t,{thingModel:this}),this.attachmentCollection.each(function(e){e.set({saved:!0})})},set:function(t,s,o){var n=i(t,s,o);return _.isArray(n.attrs.attachments)&&this.attachmentCollection&&!n.options.ignoreAttachments&&this.attachmentCollection.reset(n.attrs.attachments),_.each(n.attrs.submission_sets,function(e,t){this.submissionSets&&this.submissionSets[t]&&_.isArray(e)&&this.submissionSets[t].reset(e)},this),e.PlaceModel.__super__.set.call(this,n.attrs,n.options)},save:function(s,o,n){var a,r=this,l=i(s,o,n),c=l.attrs;n=l.options,this.isNew()?(a=n.success||t.noop,n.success=function(){r.saveAttachments(),a.apply(this,arguments)}):r.saveAttachments(),n.ignoreAttachments=!0,e.PlaceModel.__super__.save.call(this,c,n)},saveAttachments:function(){this.attachmentCollection.each(function(e){e.isNew()&&e.save()})},parse:function(e){var t=_.clone(e.properties);return _.extend(t,s(e,"place")),t.geometry=_.clone(e.geometry),t},sync:function(e,t,i){var s;return("create"===e||"update"===e)&&(s={type:"Feature",geometry:t.get("geometry"),properties:_.omit(t.toJSON(),"geometry")},i.data=JSON.stringify(s),i.contentType="application/json"),Backbone.sync(e,t,i)}}),e.PlaceCollection=e.PaginatedCollection.extend({url:"/api/places",model:e.PlaceModel,resultsAttr:"features",fetchByIds:function(e,t){var i=_.result(this,"url");1===e.length?this.fetchById(e[0],t):(e=_.map(e,function(e){return encodeURIComponent(e)}),t=t?_.clone(t):{},t.url=i+("/"===i.charAt(i.length-1)?"":"/")+e.join(","),this.fetch(_.extend({remove:!1},t)))},fetchById:function(t,i){i=i?_.clone(i):{};var s=this,o=new e.PlaceModel,n=i.success;o.id=t,o.collection=s,i.success=function(){var e=Array.prototype.slice.call(arguments);s.add(o),n&&n.apply(this,e)},o.fetch(i)}}),e.LandmarkModel=Backbone.Model.extend({initialize:function(){this.set("id",this.get("title"))},parse:function(e){var e=_.clone(e);return _.extend(e,s(e,"landmark")),_.extend(e,o(e.properties)),e}}),e.LandmarkCollection=Backbone.Collection.extend({model:e.LandmarkModel,parse:function(e,t){if(t.attributesToAdd)for(var i=0;i<e.features.length;i++)_.extend(e.features[i],t.attributesToAdd);return e.features}}),e.AttachmentModel=Backbone.Model.extend({idAttribute:"name",initialize:function(e,t){this.options=t},isNew:function(){return this.get("saved")!==!0},save:function(e,t,s){var o=i(e,t,s),n=_.extend(this.attributes,o.attrs);return this._attachBlob(n.blob,n.name,o.options)},_attachBlob:function(i,s,o){var n=new FormData,a=this,r=e.Util.wrapHandler("progress",this,o.progress),l=t.ajaxSettings.xhr();n.append("file",i),n.append("name",s),o=o||{},t.ajax({url:this.collection.url(),type:"POST",xhr:function(){return l.upload&&l.upload.addEventListener("progress",r,!1),l},success:function(){var e=Array.prototype.slice.call(arguments);e[0].saved=!0,a.set({saved:!0}),o.success&&o.success.apply(this,e)},error:o.error,data:n,cache:!1,contentType:!1,processData:!1})}}),e.AttachmentCollection=Backbone.Collection.extend({model:e.AttachmentModel,initialize:function(e,t){this.options=t},url:function(){var e=this.options.thingModel,t=e.url();return t+"/attachments"}}),e.ActionCollection=e.PaginatedCollection.extend({url:"/api/actions",comparator:function(e,t){return e.get("created_datetime")>t.get("created_datetime")?-1:1}})}(Shareabouts,jQuery),jQuery(document).ajaxSend(function(e,t,i){function s(e){var t=null;if(document.cookie&&""!==document.cookie)for(var i=document.cookie.split(";"),s=0;s<i.length;s++){var o=jQuery.trim(i[s]);if(o.substring(0,e.length+1)===e+"="){t=decodeURIComponent(o.substring(e.length+1));break}}return t}function o(e){var t=document.location.host,i=document.location.protocol,s="//"+t,o=i+s;return e==o||e.slice(0,o.length+1)==o+"/"||e==s||e.slice(0,s.length+1)==s+"/"||!/^(\/\/|http:|https:).*/.test(e)}function n(e){return/^(GET|HEAD|OPTIONS|TRACE)$/.test(e)}!n(i.type)&&o(i.url)&&t.setRequestHeader("X-CSRFToken",s("csrftoken")),"DELETE"===i.type&&(t.setRequestHeader("Content-Type","application/json"),i.data="{}")});var Shareabouts=Shareabouts||{};!function(e,t){e.PagesNavView=Backbone.View.extend({events:{"click .internal-menu-item a":"onPageLinkClick","click #nav-btn":"onMobileNavClick","click #sign-in-btn":"onAuthNavClick"},render:function(){var e=this.options.pagesConfig||[];e=e.filter(function(e){return e.hide_from_top_bar!==!0});var t={pages:e,has_pages:e.length>0},i=Handlebars.templates["pages-nav"](t);return this.$el.html(i),this},onPageLinkClick:function(i){i.preventDefault(),t(".access").removeClass("is-exposed"),this.options.router.navigate(i.target.getAttribute("href"),{trigger:!0}),e.Util.log("USER","page-menu","click-link",i.target.getAttribute("href")+" -- "+i.target.textContent)},onMobileNavClick:function(i){i.preventDefault(),t(".access").toggleClass("is-exposed"),e.Util.log("USER","page-menu",(t(".access").hasClass("is-exposed")?"show":"hide")+"-mobile-nav")},onAuthNavClick:function(e){e.preventDefault(),t(".sign-in-menu").toggleClass("is-exposed")}})}(Shareabouts,jQuery,Shareabouts.Util.console);var Shareabouts=Shareabouts||{};!function(e,t){e.AuthNavView=Backbone.View.extend({events:{"click .internal-menu-item a":"onLinkClick","click #nav-btn":"onMobileNavClick","click #sign-in-btn":"onAuthNavClick"},render:function(){var t=e.bootstrapped.currentUser,i=Handlebars.templates["auth-nav"](t);return this.$el.html(i),this},onLinkClick:function(e){e.preventDefault(),t(".access").removeClass("is-exposed"),this.options.router.navigate(e.target.getAttribute("href"),{trigger:!0})},onMobileNavClick:function(e){e.preventDefault(),t(".access").toggleClass("is-exposed")},onAuthNavClick:function(i){i.preventDefault(),t(".sign-in-menu").toggleClass("is-exposed"),e.Util.log("USER","page-menu",(t(".sign-in-menu").hasClass("is-exposed")?"show":"hide")+"-auth")}})}(Shareabouts,jQuery,Shareabouts.Util.console);var Shareabouts=Shareabouts||{};!function(e,t){e.ActivityView=Backbone.View.extend({initialize:function(){var i=this;t("body").addClass("activity-enabled"),this.activityViews=[],this.activities=this.options.activities,this.places=this.options.places,this.mergedActivities=new e.ActionCollection([]),this.$container=this.$el.parent(),this.interval=this.options.interval,this.infiniteScrollBuffer=this.options.infiniteScrollBuffer||25,this.$el.delegate("a","click",function(t){t.preventDefault();var s=this.getAttribute("data-action-type"),o=this.getAttribute("data-place-id");e.Util.log("USER","action","click",s+" -- "+o),i.options.router.navigate(this.getAttribute("href"),{trigger:!0})}),_.each(this.activities,function(e){e.on("add",i.onAddAction,i),e.on("reset",i.onResetActivity,i)})},checkForNewActivity:function(){var e=this,t={remove:!1,attribute:"target"},i={};this.fetching=!1,_.each(this.activities,function(e,t){i[t]=e.metadata}),t.complete=_.bind(function(){_.each(e.activities,function(t,s){i[s]&&(i[s].length=t.metadata.length,t.metadata=i,e.fetching[s]=!1)}),this.newContentTimeout&&clearTimeout(this.newContentTimeout),this.newContentTimeout=setTimeout(_.bind(this.checkForNewActivity,this),this.interval)},this),_.each(this.activities,function(i,s){e.fetching[s]?this.newContentTimeout=setTimeout(_.bind(this.checkForNewActivity,this),5e3):(e.fetching[s]=!0,t.attributesToAdd={datasetSlug:_.find(e.options.mapConfig.layers,function(e){return e.id==s}).slug,datasetId:_.find(e.options.mapConfig.layers,function(e){return e.id==s}).id},i.fetch(t))})},onAddAction:function(e,t){this.renderAction(e,t.indexOf(e))},onResetActivityWrapper:function(e){var t=this;return function(i){t.onResetActivity(e,i)}},onResetActivity:function(e){var t=this,i=[];e.each(function(e){var s=e.get("target_type"),o=e.get("target");_.each(t.places,function(e){e.get(o.id)||i.push("place"===s?o.id:_.last(o.place.split("/")))})}),i.length>0?_.each(t.places,function(e,s){e.fetchByIds(i,{validate:!0,attribute:"properties",attributesToAdd:{datasetSlug:_.find(t.options.mapConfig.layers,function(e){return e.id==s}).slug,datasetId:_.find(t.options.mapConfig.layers,function(e){return e.id==s}).id},success:function(){t.render()}})}):t.render()},preparePlaceData:function(){},processActionData:function(e,t){var i,s,o,n,a=e.get("target_type"),r="place"===a,l=this.options.surveyConfig,c=this.options.supportConfig,p=this.options.placeTypes[t.get("location_type")];return p?(r?(i=e.get("target"),o=this.options.placeConfig.action_text,n=this.options.placeConfig.anonymous_name):(i=t.toJSON(),a===l.submission_type?(o=this.options.surveyConfig.action_text,n=this.options.surveyConfig.anonymous_name):a===c.submission_type&&(o=this.options.supportConfig.action_text,n=this.options.supportConfig.anonymous_name)),"AEIOUaeiou".indexOf(i.location_type[0])>-1&&(i.type_starts_with_vowel=!0),i.place_type_label=p.label||i.location_type,s=_.extend({place:i,is_place:r},e.toJSON()),s.action=o,s.target.submitter_name=e.get("target").submitter_name||n,s):null},getPlaceForAction:function(e,t){var i,s,o=e.get("target").place;t=t||{},t.validate=!0,i=o?_.last(o.split("/")):e.get("target").id,_.each(this.places,function(e){s=e.get(i),s&&t.success&&t.success(s,null,t)})},renderAction:function(e,i){var s,o=this;s=function(s){var n,a;a=o.processActionData(e,s),a&&(n=t(Handlebars.templates["activity-list-item"](a)),i>=o.$el.children().length?o.$el.append(n):n.hide().insertBefore(o.$el.find(".activity-item:nth-child("+i+"1)")).slideDown())},this.getPlaceForAction(e,{success:s})},render:function(){var e,t=this,i=0,s=[];return e=Handlebars.templates["activity-list"]({activities:s}),t.$el.html(e),_.each(this.activities,function(e){t.mergedActivities.add(e.models)}),t.mergedActivities.each(function(e){t.renderAction(e,i++)}),t.checkForNewActivity(),t}})}(Shareabouts,jQuery,Shareabouts.Util.console);var Shareabouts=Shareabouts||{};!function(e,t,i){e.bigSpinnerOptions={lines:13,length:0,width:10,radius:30,corners:1,rotate:0,direction:1,color:"#000",speed:1,trail:60,shadow:!1,hwaccel:!1,className:"spinner",zIndex:2e9,top:"auto",left:"auto"},e.smallSpinnerOptions={lines:13,length:0,width:3,radius:10,corners:1,rotate:0,direction:1,color:"#000",speed:1,trail:60,shadow:!1,hwaccel:!1,className:"spinner",zIndex:2e9,top:"auto",left:"auto"},e.AppView=Backbone.View.extend({events:{"click #add-place":"onClickAddPlaceBtn","click .close-btn":"onClickClosePanelBtn"},initialize:function(){var i=this,s=e.Config.flavor.app.list_enabled!==!1,o={include_submissions:s};e.Config.flavor.app.places_page_size&&(o.page_size=e.Config.flavor.app.places_page_size),this.activities=this.options.activities,this.places=this.options.places,this.landmarks=this.options.landmarks,this.placeFormView=null,this.placeDetailViews={},this.landmarkDetailViews={},this.isProgrammaticZoom=!1,this.isStoryActive=!1,t("body").ajaxError(function(){t("#ajax-error-msg").show()}),t("body").ajaxSuccess(function(){t("#ajax-error-msg").hide()}),t(".list-toggle-btn").click(function(e){e.preventDefault(),i.toggleListView()}),t(document).on("click",".activity-item a",function(){window.app.clearLocationTypeFilter()}),t(document).on("click",'a[href^="/"]',function(e){var s,o=t(e.currentTarget),n=o.attr("href"),a=!1;return _.each(i.options.datasetConfigs.places,function(e){0===n.indexOf("/"+e.slug)&&(a=!0)}),"internal"!==o.attr("rel")&&"/"!==n&&!a&&0!==n.indexOf("/filter")||e.altKey||e.ctrlKey||e.metaKey||e.shiftKey?void 0:(e.preventDefault(),s=n.replace(/^\//,"").replace("#!/",""),i.options.router.navigate(s,{trigger:!0}),!1)}),this.options.router.bind("route",function(e){!_.contains(this.getListRoutes(),e)&&this.listView&&this.listView.isVisible()&&this.hideListView()},this),t("#map-container").append(Handlebars.templates["add-places"](this.options.placeConfig)),this.pagesNavView=new e.PagesNavView({el:"#pages-nav-container",pagesConfig:this.options.pagesConfig,router:this.options.router}).render(),this.authNavView=new e.AuthNavView({el:"#auth-nav-container",router:this.options.router}).render();var n=_.find(this.options.sidebarConfig.panels,function(e){return"basemaps"in e}).basemaps;this.mapView=new e.MapView({el:"#map",mapConfig:this.options.mapConfig,basemapConfigs:n,legend_enabled:!!this.options.sidebarConfig.legend_enabled,places:this.places,landmarks:this.landmarks,router:this.options.router,placeTypes:this.options.placeTypes,cluster:this.options.cluster,placeDetailViews:this.placeDetailViews}),i.options.sidebarConfig.enabled&&new e.SidebarView({el:"#sidebar-container",mapView:this.mapView,sidebarConfig:this.options.sidebarConfig}).render(),(_.isUndefined(this.options.activityConfig.enabled)||this.options.activityConfig.enabled)&&(this.activityView=new e.ActivityView({el:"ul.recent-points",activities:this.activities,places:this.places,router:this.options.router,placeTypes:this.options.placeTypes,surveyConfig:this.options.surveyConfig,supportConfig:this.options.supportConfig,placeConfig:this.options.placeConfig,mapConfig:this.options.mapConfig,interval:this.options.activityConfig.interval||3e4})),this.geocodeAddressView=new e.GeocodeAddressView({el:"#geocode-address-bar",router:this.options.router,mapConfig:this.options.mapConfig}).render(),this.placeCounterView=new e.PlaceCounterView({el:"#place-counter",router:this.options.router,mapConfig:this.options.mapConfig,places:this.places}).render(),t(e).on("geocode",function(e,t){i.mapView.zoomInOn(t.latLng),i.isAddingPlace()&&i.placeFormView.setLatLng(t.latLng)}),t(e).on("mapdragend",function(){i.isAddingPlace()?i.conditionallyReverseGeocode():i.geocodeAddressView&&i.geocodeAddressView.setAddress("")}),t(e).on("reversegeocode",function(e,s){var o=Handlebars.templates["location-string"](s);i.geocodeAddressView.setAddress(t.trim(o)),i.geocodeAddressPlaceView.setAddress(t.trim(o)),i.placeFormView.setLatLng(s.latLng)}),(_.isUndefined(e.Config.flavor.app.list_enabled)||e.Config.flavor.app.list_enabled)&&(this.listView=new e.PlaceListView({el:"#list-container",placeCollections:i.places}).render()),this.$panel=t("#content"),this.$panelContent=t("#content article"),this.$panelCloseBtn=t(".close-btn"),this.$centerpoint=t("#centerpoint"),this.$addButton=t("#add-place-btn-container"),this.mapView.map.on("zoomend",this.onMapZoomEnd,this),this.mapView.map.on("movestart",this.onMapMoveStart,this),this.mapView.map.on("moveend",this.onMapMoveEnd,this),this.mapView.map.on("dragend",this.onMapDragEnd,this),_.each(this.options.storyConfig,function(e){var t={},i=e.order.length;_.each(e.order,function(s,o){t[s.url]={zoom:s.zoom||e.default_zoom,panTo:s.panTo||null,visibleLayers:s.visible_layers||e.default_visible_layers,previous:e.order[(o-1+i)%i].url,next:e.order[(o+1)%i].url,basemap:s.basemap||null,spotlight:s.spotlight===!1?!1:!0}}),e.order=t}),this.offsetRatio={x:.2,y:0},_.each(this.places,function(e,t){i.placeDetailViews[t]={}}),_.each(this.landmarks,function(e,t){i.landmarkDetailViews[t]={}}),this.setBodyClass(),this.showCenterPoint(),this.loadPlaces(o),this.loadLandmarks(),_.each(this.activities,function(e,t){e.fetch({reset:!0,attribute:"target",attributesToAdd:{datasetId:_.find(i.options.mapConfig.layers,function(e){return e.id==t}).id,datasetSlug:_.find(i.options.mapConfig.layers,function(e){return e.id==t}).slug}})})},getListRoutes:function(){return["showList","filterMap"]},isAddingPlace:function(){return this.$panel.is(":visible")&&this.$panel.hasClass("place-form")},loadLandmarks:function(){var e=this;_.each(_.values(this.options.datasetConfigs.landmarks),function(t){t.placeType?e.landmarks[t.id].fetch({attributesToAdd:{location_type:t.placeType}}):e.landmarks[t.id].fetch()})},loadPlaces:function(e){var i,s,o=this,n=t("#map-progress"),a=t("#map-progress .current-progress"),r=0;_.each(o.places,function(t,l){t.fetchAllPages({remove:!1,validate:!0,data:e,attributesToAdd:{datasetSlug:_.find(o.options.mapConfig.layers,function(e){return e.id==l}).slug,datasetId:_.find(o.options.mapConfig.layers,function(e){return e.id==l}).id},attribute:"properties",pageSuccess:_.once(function(e,t){i=t.features.length,s=Math.ceil(t.metadata.length/i),t.metadata.next&&n.show()}),pageComplete:function(){var e;r++,e=r/s*100,a.width(e+"%"),r===s&&_.delay(function(){n.hide()},2e3)}})})},setPlaceFormViewLatLng:function(e){this.placeFormView&&this.placeFormView.setLatLng(e)},onMapZoomEnd:function(){this.hasBodyClass("content-visible")!==!0||this.isProgrammaticZoom||t("#spotlight-place-mask").remove(),this.isProgrammaticZoom=!1},onMapMoveStart:function(){this.$centerpoint.addClass("dragging")},onMapMoveEnd:function(){var e=this.mapView.map.getCenter(),t=this.mapView.map.getZoom();this.$centerpoint.removeClass("dragging"),this.placeFormView&&this.placeFormView.center&&this.setPlaceFormViewLatLng(e),this.hasBodyClass("content-visible")===!1&&this.setLocationRoute(t,e.lat,e.lng)},onMapDragEnd:function(){this.hasBodyClass("content-visible")===!0&&t("#spotlight-place-mask").remove(),this.setPlaceFormViewLatLng(this.mapView.map.getCenter())},onClickAddPlaceBtn:function(t){t.preventDefault(),e.Util.log("USER","map","new-place-btn-click"),this.options.router.navigate("/new",{trigger:!0})},onClickClosePanelBtn:function(i){i.preventDefault(),this.placeFormView&&this.placeFormView.closePanel(),e.Util.log("USER","panel","close-btn-click"),t("#spotlight-place-mask").remove(),this.mapView.locationTypeFilter?this.options.router.navigate("filter/"+this.mapView.locationTypeFilter,{trigger:!0}):this.options.router.navigate("/",{trigger:!0}),this.isStoryActive&&(this.isStoryActive=!1,this.restoreDefaultLayerVisibility())},setBodyClass:function(){var i,s=["content-visible","place-form-visible"],o=Array.prototype.slice.call(arguments,0),n=t("body");for(i=0;i<s.length;++i)n.removeClass(s[i]);for(i=0;i<o.length;++i)-1===_.indexOf(s,o[i])&&e.Util.console.error("Setting an unrecognized body class.\nYou should probably just use jQuery directly."),n.addClass(o[i])},hasBodyClass:function(e){return t("body").hasClass(e)},conditionallyReverseGeocode:function(){this.options.mapConfig.geocoding_enabled&&this.mapView.reverseGeocodeMapCenter()},onRemovePlace:function(e){this.placeDetailViews[e.cid]&&(this.placeDetailViews[e.cid].remove(),delete this.placeDetailViews[e.cid])},getLandmarkDetailView:function(t,i){var s;return this.landmarkDetailViews[t]&&this.landmarkDetailViews[t][i.id]?s=this.landmarkDetailViews[t][i.id]:(s=new e.LandmarkDetailView({model:i,description:i.get("properties").description,originalDescription:i.get("properties").originalDescription,mapConfig:this.options.mapConfig,mapView:this.mapView,router:this.options.router}),this.landmarkDetailViews[t][i.id]=s),s},getPlaceDetailView:function(t){var i;return this.placeDetailViews[t.cid]?i=this.placeDetailViews[t.cid]:(i=new e.PlaceDetailView({model:t,surveyConfig:this.options.surveyConfig,supportConfig:this.options.supportConfig,placeConfig:this.options.placeConfig,storyConfig:this.options.storyConfig,mapConfig:this.options.mapConfig,placeTypes:this.options.placeTypes,userToken:this.options.userToken,mapView:this.mapView,router:this.options.router,url:_.find(this.options.mapConfig.layers,function(e){return e.slug==t.attributes.datasetSlug}).url,datasetId:_.find(this.options.mapConfig.layers,function(e){return e.slug==t.attributes.datasetSlug}).id}),this.placeDetailViews[t.cid]=i),i},setLocationRoute:function(e,t,i){this.options.router.navigate("/"+e+"/"+parseFloat(t).toFixed(5)+"/"+parseFloat(i).toFixed(5))},viewMap:function(e,t,i){var s,o=this;e&&t&&i&&(s=L.latLng(parseFloat(t),parseFloat(i)),_.defer(function(){o.mapView.map.setView(s,parseInt(e,10))})),this.hidePanel(),this.hideNewPin(),this.destroyNewModels(),this.setBodyClass()},newPlace:function(){this.placeFormView||(this.placeFormView=new e.PlaceFormView({appView:this,router:this.options.router,placeConfig:this.options.placeConfig,mapConfig:this.options.mapConfig,userToken:this.options.userToken,collection:this.places})),this.$panel.removeClass().addClass("place-form"),this.showPanel(this.placeFormView.render().$el),this.placeFormView.postRender(),this.placeFormView.delegateEvents(),this.geocodeAddressPlaceView=new e.GeocodeAddressPlaceView({el:"#geocode-address-place-bar",router:this.options.router,mapConfig:this.options.mapConfig}).render(),this.showNewPin(),this.setBodyClass("content-visible","place-form-visible")},setStoryLayerVisibility:function(i){i.attributes.story.basemap&&(t(e).trigger("visibility",[i.attributes.story.basemap,!0,!0]),t("#map-"+i.attributes.story.basemap).prop("checked",!0)),_.each(i.attributes.story.visibleLayers,function(i){t(e).trigger("visibility",[i,!0]),t("#map-"+i).prop("checked",!0)}),_.each(this.options.mapConfig.layers,function(s){_.contains(i.attributes.story.visibleLayers,s.id)||"basemap"!=s.type&&(t(e).trigger("visibility",[s.id,!1]),t("#map-"+s.id).prop("checked",!1))})},restoreDefaultLayerVisibility:function(){var i=function(i,s,o){t(e).trigger("visibility",[i,s,o]),t("#map-"+i).prop("checked",s)},s=_.find(this.options.sidebarConfig.panels,function(e){return"gis-layers"===e.id});_.each(s.basemaps,function(e){e.visibleDefault&&i(e.id,!0,!0)}),_.each(s.groupings,function(e){_.each(e.layers,function(e){i(e.id,e.visibleDefault?!0:!1,!1)})})},viewLandmark:function(i,s){{var o,n,a,r=this;e.Config.flavor.app.list_enabled!==!1,e.Util.getPageLayout()}if(o=function(e,i,o){var n,a,l,c=r.mapView.map;s=o?o:s,n=r.mapView.layerViews[s.collectionId][e.id].layer,n&&(a=n.getLatLng?n.getLatLng():n.getBounds().getCenter()),l=r.getLandmarkDetailView(s.collectionId,e),r.$panel.removeClass().addClass("place-detail place-detail-"+e),r.showPanel(l.render().$el,!1),l.delegateEvents(),r.hideNewPin(),r.destroyNewModels(),r.hideCenterPoint(),r.setBodyClass("content-visible"),n&&(s.zoom?n.getLatLng?e.attributes.story?(r.setStoryLayerVisibility(e),r.isProgrammaticZoom=!0,c.setView(e.attributes.story.panTo||a,e.attributes.story.zoom,{animate:!0})):c.setView(a,c.getMaxZoom()-1,{reset:!0}):c.fitBounds(n.getBounds()):e.attributes.story?(r.isProgrammaticZoom=!0,r.setStoryLayerVisibility(e),c.setView(e.attributes.story.panTo||a,e.attributes.story.zoom,{animate:!0})):c.panTo(a,{animate:!0})),r.addSpotlightMask(),e.trigger("focus"),e.get("story")?(e.get("story").spotlight||t("#spotlight-place-mask").remove(),r.isStoryActive=!0,r.setStoryLayerVisibility(e)):r.isStoryActive?(r.isStoryActive=!1,r.restoreDefaultLayerVisibility()):r.isStoryActive=!1},n=function(){s.stillSearching[s.collectionId]=!1;var e=!0;_.each(_.values(s.stillSearching),function(t){t&&(e=!1)}),e&&r.options.router.navigate("/")},void 0===s.collectionId){var l,c;if(_.find(Object.keys(r.options.landmarks),function(e){return c=e,l=r.landmarks[c].get(i)}),l)return void o(l,{},{collectionId:c,zoom:s.zoom});var p={};return _.each(r.options.datasetConfigs.landmarks,function(e){p[e.id]=!0}),void _.each(r.options.datasetConfigs.landmarks,function(e){r.viewLandmark(i,{collectionId:e.id,zoom:s.zoom,stillSearching:p})})}if(i instanceof e.LandmarkModel)return void o(i);a=i;var u=this.landmarks[s.collectionId];return u?(i=u.get(a),void(i?o(i):u.fetch({success:function(e){var t=e.findWhere({id:a});t?o(t):n()},error:n}))):void n()},viewPlace:function(i,s,o,n){var a,r,l,c=this,p=e.Config.flavor.app.list_enabled!==!1,u=e.Util.getPageLayout(),d=_.find(c.options.mapConfig.layers,function(e){return e.slug==i}).id;return a=function(e){var i,s,a,r,l=c.mapView.map;_.isUndefined(c.mapView.layerViews[e.cid])&&(e=c.places[d].get(e.id)),c.mapView.layerViews[d]&&c.mapView.layerViews[d][e.cid]&&(i=c.mapView.layerViews[d][e.cid].layer),a=c.getPlaceDetailView(e),i&&(s=i.getLatLng?i.getLatLng():i.getBounds().getCenter()),c.$panel.removeClass().addClass("place-detail place-detail-"+e.id),c.showPanel(a.render().$el,!!o),a.delegateEvents(),c.hideNewPin(),c.destroyNewModels(),c.hideCenterPoint(),c.setBodyClass("content-visible"),i&&(n?i.getLatLng?e.attributes.story?(c.isProgrammaticZoom=!0,c.setStoryLayerVisibility(e),l.setView(e.attributes.story.panTo||s,e.attributes.story.zoom,{animate:!0})):l.setView(s,l.getMaxZoom()-1,{reset:!0}):l.fitBounds(i.getBounds()):e.attributes.story?(c.isProgrammaticZoom=!0,c.setStoryLayerVisibility(e),l.setView(e.attributes.story.panTo||s,e.attributes.story.zoom,{animate:!0})):l.panTo(s,{animate:!0})),c.addSpotlightMask(),o&&(r=a.$el.find('[data-response-id="'+o+'"]'),r.length>0&&("desktop"===u?c.$panelContent.scrollTo(r,500):t(window).scrollTo(r,500))),e.trigger("focus"),e.get("story")?(e.get("story").spotlight||t("#spotlight-place-mask").remove(),c.isStoryActive=!0,c.setStoryLayerVisibility(e)):c.isStoryActive?(c.isStoryActive=!1,c.restoreDefaultLayerVisibility()):c.isStoryActive=!1},r=function(){c.options.router.navigate("/")},s instanceof e.PlaceModel?void a(s):(l=s,s=this.places[d].get(l),void(s?a(s):this.places[d].fetchById(l,{validate:!0,success:a,error:r,data:{include_submissions:p}})))},viewPage:function(t){var i=e.Util.findPageConfig(this.options.pagesConfig,{slug:t}),s="pages/"+(i.name||i.slug),o=Handlebars.templates[s]({
config:this.options.config});this.$panel.removeClass().addClass("page page-"+t),this.showPanel(o),this.hideNewPin(),this.destroyNewModels(),this.hideCenterPoint(),this.setBodyClass("content-visible")},showPanel:function(s,o){i.log("show panel"),i.log("this.$panel",this.$panel),this.$panel.hasClass("place-detail")&&i.log("replacing place detail");var n=this.mapView.map;if(this.unfocusAllPlaces(),this.$panelContent.html(s),this.$panel.show(),!o){var a=e.Util.getPageLayout();"desktop"===a?this.$panelContent.scrollTo(0,0):window.scrollTo(0,0)}this.setBodyClass("content-visible"),n.invalidateSize({animate:!0,pan:!0}),t(e).trigger("panelshow",[this.options.router,Backbone.history.getFragment()]),t("#add-place-btn-container").attr("class","pos-top-left"),e.Util.log("APP","panel-state","open")},showNewPin:function(){this.$centerpoint.show().addClass("newpin"),this.addSpotlightMask()},showAddButton:function(){this.$addButton.show()},hideAddButton:function(){this.$addButton.hide()},showCenterPoint:function(){this.$centerpoint.show().removeClass("newpin")},hideCenterPoint:function(){this.$centerpoint.hide()},hidePanel:function(){var i=this.mapView.map;this.unfocusAllPlaces(),this.$panel.hide(),this.setBodyClass(),i.invalidateSize({animate:!0,pan:!0}),t("#add-place-btn-container").attr("class","pos-top-right"),e.Util.log("APP","panel-state","closed"),t("#spotlight-place-mask").remove()},hideNewPin:function(){this.showCenterPoint()},addSpotlightMask:function(){t("#spotlight-place-mask").remove();var e=200,i=t("#map").width()/2-e/2,s=t("#map").height()/2-e/2;t("#map").append("<div id='spotlight-place-mask'><div id='spotlight-place-mask-fill'></div></div>"),t("#spotlight-place-mask-fill").css("left",i+"px").css("top",s+"px").css("width",e+"px").css("height",e+"px").css("box-shadow","0px 0px 0px "+Math.max(2*s,2*i)+"px rgba(0,0,0,0.4), inset 0px 0px 20px 30px rgba(0,0,0,0.4)")},unfocusAllPlaces:function(){_.each(this.places,function(e){e.each(function(e){e.isNew()||e.trigger("unfocus")})}),_.each(this.landmarks,function(e){e.each(function(e){e.isNew()||e.trigger("unfocus")})})},destroyNewModels:function(){_.each(this.places,function(e){e.each(function(e){e&&e.isNew()&&e.destroy()})}),_.each(this.landmarks,function(e){e.each(function(e){e&&e.isNew()&&e.destroy()})})},render:function(){this.mapView.render()},showListView:function(){this.listView.sort(),this.listView.$el.addClass("is-exposed"),t(".show-the-list").addClass("is-visuallyhidden"),t(".show-the-map").removeClass("is-visuallyhidden")},hideListView:function(){this.listView.$el.removeClass("is-exposed"),t(".show-the-list").removeClass("is-visuallyhidden"),t(".show-the-map").addClass("is-visuallyhidden")},toggleListView:function(){this.listView.isVisible()?(this.viewMap(),this.hideListView(),this.options.router.navigate("")):(this.showListView(),this.options.router.navigate("list")),this.mapView.clearFilter()}})}(Shareabouts,jQuery,Shareabouts.Util.console);var Shareabouts=Shareabouts||{};!function(e,t,i){e.LayerView=Backbone.View.extend({initialize:function(){this.map=this.options.map,this.isFocused=!1,this.throttledRender=_.throttle(this.render,300),this.map.on("zoomend",this.updateLayer,this),this.model.on("change",this.updateLayer,this),this.model.on("focus",this.focus,this),this.model.on("unfocus",this.unfocus,this),this.model.on("destroy",this.onDestroy,this),this.map.on("move",this.throttledRender,this),this.initLayer()},initLayer:function(){var e,t;if(this.placeType=this.options.placeTypes[this.model.get("location_type")],!this.placeType)return void i.warn("Place type",this.model.get("location_type"),"is not configured so it will not appear on the map.");if(!this.model.isNew()){if(t=_.extend({},this.model.toJSON(),{map:{zoom:this.map.getZoom()}},{layer:{focused:this.isFocused}}),this.styleRule=L.Argo.getStyleRule(t,this.placeType.rules),this.placeType.hasOwnProperty("zoomType")){var s=this.options.placeTypes[this.placeType.zoomType];this.styleRule=L.Argo.getZoomRule(this.styleRule,s)}e=this.model.get("geometry"),"Point"===e.type?(this.latLng=L.latLng(e.coordinates[1],e.coordinates[0]),this.hasIcon()?this.layer=this.isFocused&&this.styleRule.focus_icon?L.marker(this.latLng,{icon:L.icon(this.styleRule.focus_icon)}):L.marker(this.latLng,{icon:L.icon(this.styleRule.icon)}):this.hasStyle()&&(this.layer=this.isFocused&&this.styleRule.focus_style?L.circleMarker(this.latLng,this.styleRule.focus_style):L.circleMarker(this.latLng,this.styleRule.style))):(this.layer=L.GeoJSON.geometryToLayer(e),this.layer.setStyle(this.styleRule.style)),this.layer&&this.layer.on("click",this.onMarkerClick,this),this.render()}},onDestroy:function(){this.map.off("zoomend",this.updateLayer,this)},updateLayer:function(){this.removeLayer(),this.initLayer()},removeLayer:function(){this.layer&&this.options.layer.removeLayer(this.layer)},render:function(){var e=this.map.getBounds();this.latLng?e.contains(this.latLng)?this.show():this.hide():this.show()},onMarkerClick:function(){e.Util.log("USER","map","place-marker-click",this.model.getLoggingDetails()),this.options.router.navigate("/"+this.model.get("datasetSlug")+"/"+this.model.id,{trigger:!0})},isPoint:function(){return"Point"==this.model.get("geometry").type},hasIcon:function(){return this.styleRule&&this.styleRule.icon},hasStyle:function(){return this.styleRule&&this.styleRule.style},focus:function(){this.isFocused||(this.isFocused=!0,this.updateLayer())},unfocus:function(){this.isFocused&&(this.isFocused=!1,this.updateLayer())},remove:function(){this.removeLayer(),this.map.off("move",this.throttledRender,this)},setIcon:function(e){this.layer&&this.layer.setIcon(e)},show:function(){this.options.mapView.locationTypeFilter&&this.options.mapView.locationTypeFilter.toUpperCase()!==this.model.get("location_type").toUpperCase()?this.hide():this.layer&&this.options.layer.addLayer(this.layer)},hide:function(){this.removeLayer()}})}(Shareabouts,jQuery,Shareabouts.Util.console);var Shareabouts=Shareabouts||{};!function(e){e.BasicLayerView=e.LayerView.extend({initialize:function(){e.LayerView.prototype.initialize.call(this)},removeLayer:function(){this.layer&&this.options.layer.removeLayer(this.layer)},onMarkerClick:function(){e.Util.log("USER","map","landmark-layer-click",this.model.getLoggingDetails()),this.options.router.navigate("/"+this.model.id,{trigger:!0})},show:function(){this.options.mapView.locationTypeFilter&&this.options.mapView.locationTypeFilter.toUpperCase()!==this.model.get("location_type").toUpperCase()?this.hide():this.layer&&this.options.layer.addLayer(this.layer)}})}(Shareabouts,jQuery,Shareabouts.Util.console);var Shareabouts=Shareabouts||{};!function(e){e.PlaceCounterView=Backbone.View.extend({initialize:function(){var e=this;e.numberOfPlaces=0,_.each(this.options.places.duwamish,function(t){e.numberOfPlaces+=t.models.length,t.on("reset",e.render,e),t.on("add",e.incrementPlaces,e),t.on("remove",e.decrementPlaces,e)})},incrementPlaces:function(){this.numberOfPlaces++,this.render()},decrementPlaces:function(){this.numberOfPlaces--,this.render()},render:function(){var t={meter_config:this.options.mapConfig,value:this.numberOfPlaces,value_pretty:e.TemplateHelpers.formatNumber(this.numberOfPlaces),counter_max_pretty:e.TemplateHelpers.formatNumber(this.options.mapConfig.counter_max)};return this.$el.html(Handlebars.templates["count-meter"](t)),this}})}(Shareabouts,jQuery,Shareabouts.Util.console);var Shareabouts=Shareabouts||{};!function(e,t,i){e.GeocodeAddressView=Backbone.View.extend({events:{"submit .geocode-address-form":"onGeocodeAddress","change .geocode-address-field":"onAddressChange"},render:function(){var e=this.options.mapConfig;return this.$el.html(Handlebars.templates["geocode-address"](e)),this},onAddressChange:function(){this.$(".error").hide().addClass("is-hidden")},onGeocodeAddress:function(s){s.preventDefault();var o=this,n=this.$(".geocode-address-field"),a=n.val(),r=this.options.mapConfig.geocoding_engine||"MapQuest",l=this.options.mapConfig.geocode_bounding_box||this.options.mapConfig.geocode_hint;o.$(".geocode-spinner").removeClass("is-hidden"),0===o.$(".geocode-spinner > .spinner").length&&new Spinner(e.smallSpinnerOptions).spin(this.$(".geocode-spinner")[0]),e.Util[r].geocode(a,l,{success:function(s){var n=s.results[0].locations;o.$(".geocode-spinner").addClass("is-hidden"),n.length>0?t(e).trigger("geocode",[n[0]]):(i.error("Woah, no location found for ",s.results[0].providedLocation.location,s),o.$(".error").removeClass("is-hidden").hide().fadeIn().html("Could not find that location."))},error:function(){i.error("There was an error while geocoding: ",arguments),o.$(".loading").addClass("is-hidden")}}),e.Util.log("USER","geocoder","geocode-address",a)},setAddress:function(e){var t=this.$(".geocode-address-field");t.val(e).change()}})}(Shareabouts,jQuery,Shareabouts.Util.console);var Shareabouts=Shareabouts||{};!function(e){e.GeocodeAddressPlaceView=e.GeocodeAddressView.extend({events:{"change .geocode-address-field":"onAddressChange","blur .geocode-address-field":"onGeocodeAddress"},render:function(){return this}})}(Shareabouts,jQuery,Shareabouts.Util.console);var Shareabouts=Shareabouts||{};!function(e){e.SupportView=Backbone.View.extend({events:{"change #support":"onSupportChange"},initialize:function(){this.collection.on("reset",this.onChange,this),this.collection.on("add",this.onChange,this),this.collection.on("remove",this.onChange,this),this.updateSupportStatus()},render:function(){return this.delegateEvents(),this.$el.html(Handlebars.templates["place-detail-support"]({count:this.collection.size()||"",user_token:this.options.userToken,is_supporting:void 0!==this.userSupport,support_config:this.options.supportConfig})),this},remove:function(){},getSupportStatus:function(e){return this.collection.find(function(t){return t.get("user_token")===e})},updateSupportStatus:function(){this.userSupport=this.getSupportStatus(this.options.userToken)},onChange:function(){this.updateSupportStatus(),this.render()},onSupportChange:function(t){var i,s,o,n=this,a=t.target.checked;t.target.disabled=!0,e.Util.log("USER","place","support-btn-click",n.collection.options.placeModel.getLoggingDetails(),n.collection.size()),a?(i=this.$("form"),s=e.Util.getAttrs(i),this.collection.create(s,{wait:!0,beforeSend:function(t){e.bootstrapped.currentUser||t.setRequestHeader("X-Shareabouts-Silent","true")},success:function(){e.Util.log("USER","place","successfully-support",n.collection.options.placeModel.getLoggingDetails())},error:function(){n.getSupportStatus(n.options.userToken).destroy(),alert("Oh dear. It looks like that didn't save."),e.Util.log("USER","place","fail-to-support",n.collection.options.placeModel.getLoggingDetails())}})):(o=this.userSupport,this.userSupport.destroy({wait:!0,success:function(){e.Util.log("USER","place","successfully-unsupport",n.collection.options.placeModel.getLoggingDetails())},error:function(){n.collection.add(o),alert("Oh dear. It looks like that didn't save."),e.Util.log("USER","place","fail-to-unsupport",n.collection.options.placeModel.getLoggingDetails())}}))}})}(Shareabouts,jQuery,Shareabouts.Util.console);var Shareabouts=Shareabouts||{};!function(e,t){e.SurveyView=Backbone.View.extend({events:{"submit form":"onSubmit","click .reply-link":"onReplyClick","click .update-response-btn":"onUpdateResponse","click .delete-response-btn":"onDeleteResponse"},initialize:function(){e.TemplateHelpers.insertInputTypeFlags(this.options.surveyConfig.items),this.collection.on("reset",this.onChange,this),this.collection.on("add",this.onChange,this),this.updateSubmissionStatus()},getSubmissionStatus:function(e){return this.collection.find(function(t){return t.get("user_token")===e})},updateSubmissionStatus:function(){this.userSubmission=this.getSubmissionStatus(this.options.userToken)},render:function(){var i,s,o,n=this,a=[],r=window.location.toString(),l=r.split("response/"),c=e.Util.getPageLayout();if(2===l.length&&(i=l[1]),this.delegateEvents(),this.collection.each(function(t){var i=e.TemplateHelpers.getItemsFromModel(n.options.surveyConfig.items,t,["submitter_name"]);a.push(_.extend(t.toJSON(),{submitter_name:t.get("submitter_name")||n.options.surveyConfig.anonymous_name,cid:t.cid,pretty_created_datetime:e.Util.getPrettyDateTime(t.get("created_datetime"),n.options.surveyConfig.pretty_datetime_format),items:i}))}),o=_.extend({responses:a,has_single_response:1===a.length,user_token:this.options.userToken,user_submitted:!!this.userSubmission,survey_config:this.options.surveyConfig,isEditingToggled:this.options.placeDetailView.isEditingToggled},e.stickyFieldValues),this.$el.html(Handlebars.templates["place-detail-survey"](o)),s=this.$el.find('[data-response-id="'+i+'"]'),s.length>0&&setTimeout(function(){"desktop"===c?t("#content article").scrollTo(s):t(window).scrollTo(s)},700),this.options.placeDetailView.isEditingToggled){var p="change keyup";t.each(this.$el.find(".responses form"),function(){t(this).on(p,function(){t(this).siblings(".btn-update").removeClass("faded").prop("disabled",!1)})})}return this},remove:function(){this.unbind(),this.$el.remove()},onChange:function(){this.updateSubmissionStatus(),this.render()},onSubmit:Gatekeeper.onValidSubmit(function(t){t.preventDefault();var i,s=this,o=this.$("form"),n=this.$('[name="commit"]'),a=e.Util.getAttrs(o);n.attr("disabled","disabled"),i=new Spinner(e.smallSpinnerOptions).spin(this.$(".form-spinner")[0]),e.Util.log("USER","place","submit-reply-btn-click",this.collection.options.placeModel.getLoggingDetails(),this.collection.size()),e.Util.setStickyFields(a,e.Config.survey.items,e.Config.place.items),this.collection.create(a,{wait:!0,success:function(){o.get(0).reset(),e.Util.log("USER","place","successfully-reply",s.collection.options.placeModel.getLoggingDetails())},error:function(){e.Util.log("USER","place","fail-to-reply",s.collection.options.placeModel.getLoggingDetails())},complete:function(){n.removeAttr("disabled"),i.stop()}})}),onReplyClick:function(t){t.preventDefault(),this.$("textarea, input").not('[type="hidden"]').first().focus(),e.Util.log("USER","place","leave-reply-btn-click",this.collection.options.placeModel.getLoggingDetails(),this.collection.size())},onUpdateResponse:function(i){var s=t(i.target).parent().data("cid"),o=this.collection.get(s),n=t(i.target).siblings("form"),a=e.Util.getAttrs(n);o.set(a).save({},{success:function(){t(i.target).addClass("faded").prop("disabled",!0)}})},onDeleteResponse:function(e){var i=confirm("You are deleting this comment permanently. Are you sure you want to continue?");if(i){var s=t(e.target).parent().data("cid"),o=this.collection.get(s);o.destroy(),this.render()}}})}(Shareabouts,jQuery,Shareabouts.Util.console);var Shareabouts=Shareabouts||{};!function(e,t){e.LandmarkSurveyView=e.SurveyView.extend({initialize:function(){},render:function(){var i,s,o=e.Util.getPageLayout();return this.$el.html(Handlebars.templates["place-detail-survey"]({})),s=this.$el.find('[data-response-id="'+i+'"]'),s.length>0&&setTimeout(function(){"desktop"===o?t("#content article").scrollTo(s):t(window).scrollTo(s)},700),this}})}(Shareabouts,jQuery,Shareabouts.Util.console);var Shareabouts=Shareabouts||{};!function(e,t,i){e.PlaceDetailView=Backbone.View.extend({events:{"click .place-story-bar .btn-previous-story-nav":"onClickStoryPrevious","click .place-story-bar .btn-next-story-nav":"onClickStoryNext","click #toggle-editor-btn":"onToggleEditMode","click #update-place-model-btn":"onUpdateModel","click #hide-place-model-btn":"onHideModel",'click input[data-input-type="binary_toggle"]':"onBinaryToggle",'change input[type="file"]':"onInputFileChange"},initialize:function(){var t=this;this.isEditable=!1,this.isEditingToggled=!1,this.surveyType=this.options.surveyConfig.submission_type,this.supportType=this.options.supportConfig.submission_type,this.isModified=!1,this.model.on("change",this.onChange,this),this.model.submissionSets[this.surveyType]=this.model.submissionSets[this.surveyType]||new e.SubmissionCollection(null,{submissionType:this.surveyType,placeModel:this.model}),this.model.submissionSets[this.supportType]=this.model.submissionSets[this.supportType]||new e.SubmissionCollection(null,{submissionType:this.supportType,placeModel:this.model}),this.surveyView=new e.SurveyView({collection:this.model.submissionSets[this.surveyType],surveyConfig:this.options.surveyConfig,userToken:this.options.userToken,datasetId:t.options.datasetId,placeDetailView:t}),this.supportView=new e.SupportView({collection:this.model.submissionSets[this.supportType],supportConfig:this.options.supportConfig,userToken:this.options.userToken,datasetId:t.options.datasetId}),this.model.submissionSets[this.surveyType].fetchAllPages(),this.$el.on("click",".share-link a",function(){var i=this.getAttribute("data-shareto");e.Util.log("USER","place",i,t.model.getLoggingDetails())}),e.bootstrapped.currentUser&&e.bootstrapped.currentUser.groups&&_.each(e.bootstrapped.currentUser.groups,function(e){var i=e.dataset.split("/"),s=i[i.length-1];s&&s===t.options.datasetId&&"administrators"===e.name&&(t.isEditable=!0)}),this.model.attachmentCollection.on("add",this.onAddAttachment,this)},onClickStoryPrevious:function(){this.options.router.navigate(this.model.attributes.story.previous,{trigger:!0})},onClickStoryNext:function(){this.options.router.navigate(this.model.attributes.story.next,{trigger:!0})},close:function(){i.log("on close")},onToggleEditMode:function(){if(i.log("this.isModified",this.isModified),!this.isEditingToggled||!this.isModified||confirm("You have unsaved changes. Proceed?")){var e=!this.isEditingToggled;this.isEditingToggled=e,this.surveyView.options.isEditingToggled=e,this.render()}},render:function(){i.log("place detail view render");var e=this,s=_.extend({place_config:this.options.placeConfig,survey_config:this.options.surveyConfig,url:this.options.url,isEditable:e.isEditable||!1,isEditingToggled:e.isEditingToggled||!1},this.model.toJSON());if(s.submitter_name=this.model.get("submitter_name")||this.options.placeConfig.anonymous_name,s.attachments=this.model.attachmentCollection.toJSON(),this.$el.html(Handlebars.templates["place-detail"](s)),this.$(".survey").html(this.surveyView.render().$el),this.$(".support").html(this.supportView.render().$el),this.model.submissionSets[this.supportType].fetchAllPages(),this.delegateEvents(),this.surveyView.delegateEvents(),t("#content article").animate({scrollTop:0},"fast"),t("#datetimepicker").datetimepicker({formatTime:"g:i a"}),this.isEditingToggled){var o="change keyup";t("#toggle-editor-btn").addClass("btn-depressed"),t(".promotion, .place-submission-details, .survey-header, .reply-link, .response-header").addClass("faded"),t("#update-place-model-form, #update-place-model-title-form").on(o,function(){e.isModified=!0,t("#update-place-model-btn").css({opacity:"1.0",cursor:"pointer"}),t(this).off(o)})}return this},remove:function(){},onChange:function(){this.render()},onInputFileChange:function(t){var i,s,o=this;t.target.files&&t.target.files.length&&(i=t.target.files[0],this.$(".fileinput-name").text(i.name),e.Util.fileToCanvas(i,function(e){e.toBlob(function(t){var i=Math.random().toString(36).substring(7),n={name:i,blob:t,file:e.toDataURL("image/jpeg")};s=o.model.attachmentCollection.find(function(e){return e.get("name")===i}),_.isUndefined(s)?o.model.attachmentCollection.add(n):s.set(n)},"image/jpeg")},{maxWidth:800,maxHeight:800,canvas:!0}))},onAddAttachment:function(e){e.save(),this.render()},onBinaryToggle:function(e){var i=this.model.get("location_type"),s=t(e.target).attr("id"),o=t(e.target).val(),n=_.find(this.options.placeConfig.place_detail,function(e){return e.category===i}),a=_.find(n.fields,function(e){return e.name===s}),r=_.find(a.content,function(e){return e.value!=o});t(e.target).val(r.value),t(e.target).next("label").html(r.label)},onUpdateModel:function(){var i=this,s=_.extend(e.Util.getAttrs(t("#update-place-model-form")),e.Util.getAttrs(t("#update-place-model-title-form")));t('input[data-input-type="binary_toggle"]').each(function(){t(this).is(":checked")||i.model.unset(t(this).attr("id"))}),this.model.save(s,{success:function(){i.isModified=!1,i.isEditingToggled=!1,i.render()},error:function(){}})},onHideModel:function(){var e=this;confirm("Are you sure you want to hide this post? It will no longer be visible on the map.")&&this.model.save({visible:!1},{success:function(){e.model.trigger("userHideModel",e.model)},error:function(){}})}})}(Shareabouts,jQuery,Shareabouts.Util.console);var Shareabouts=Shareabouts||{};!function(e,t){e.LandmarkDetailView=e.PlaceDetailView.extend({initialize:function(){this.description=this.options.description,this.originalDescription=this.options.originalDescription,this.model=this.options.model,this.landmarkSurveyView=new e.LandmarkSurveyView({})},render:function(){var e={description:this.description,story:this.model.attributes.story,title:this.model.attributes.title,fullTitle:this.model.attributes.fullTitle};return this.$el.html(Handlebars.templates["place-detail-story-bar"](e)),this.$el.append(this.model.attributes.story?this.description:this.originalDescription),this.$(".survey").html(this.landmarkSurveyView.render().$el),this.$el.append(Handlebars.templates["place-detail-story-bar-tagline"](e)),this.delegateEvents(),t("#content article").animate({scrollTop:0},"fast"),this}})}(Shareabouts,jQuery,Shareabouts.Util.console);var Shareabouts=Shareabouts||{};!function(e,t,i){e.PlaceFormView=Backbone.View.extend({events:{"submit form":"onSubmit",'change input[type="file"]':"onInputFileChange","click .category-btn.clickable + label":"onCategoryChange","click .category-menu-hamburger":"onExpandCategories",'click input[data-input-type="binary_toggle"]':"onBinaryToggle","click .btn-geolocate":"onClickGeolocate"},initialize:function(){this.resetFormState(),e.TemplateHelpers.overridePlaceTypeConfig(this.options.placeConfig.items,this.options.defaultPlaceTypeName),e.TemplateHelpers.insertInputTypeFlags(this.options.placeConfig.items)},resetFormState:function(){this.formState={selectedCategory:null,selectedDatasetId:null,selectedDatasetSlug:null,isSingleCategory:!1,attachmentData:null,placeDetail:this.options.placeConfig.place_detail}},render:function(i,s){var o=this,n=i&&_.find(o.formState.placeDetail,function(e){return e.category===i})||{},a=_.filter(o.formState.placeDetail,function(e){return e.includeOnForm});1===a.length&&(this.formState.isSingleCategory=!0,s=!0,i=a[0].category,this.formState.selectedCategory=i,this.formState.selectedDatasetId=a[0].dataset,this.formState.selectedDatasetSlug=_.find(this.options.mapConfig.layers,function(e){return o.formState.selectedDatasetId==e.id}).slug,n=a[0]);var r=_.extend({isCategorySelected:s,placeConfig:this.options.placeConfig,selectedCategory:n,user_token:this.options.userToken,current_user:e.currentUser,isSingleCategory:this.formState.isSingleCategory},e.stickyFieldValues);return this.$el.html(Handlebars.templates["place-form"](r)),this.center&&t(".drag-marker-instructions").addClass("is-visuallyhidden"),this},postRender:function(){t("#datetimepicker").datetimepicker({formatTime:"g:i a"})},remove:function(){this.unbind()},onError:function(e,t){i.log("oh no errors!!",e,t)},setLatLng:function(e){this.center=e,this.$(".drag-marker-instructions, .drag-marker-warning").addClass("is-visuallyhidden")},setLocation:function(e){this.location=e},getAttrs:function(){var i={},s=this.options.placeConfig.location_item_name,o=this.$("form");return i=e.Util.getAttrs(o),t.each(t("input[data-input-type='binary_toggle']:not(:checked)"),function(){i[t(this).attr("name")]=t(this).val()}),i.geometry={type:"Point",coordinates:[this.center.lng,this.center.lat]},this.location&&s&&(i[s]=this.location),i},onCategoryChange:function(e){var i=this,s=400;this.formState.selectedCategory=t(e.target).parent().prev().attr("id"),this.formState.selectedDatasetId=_.find(i.formState.placeDetail,function(e){return e.category===i.formState.selectedCategory}).dataset,this.formState.selectedDatasetSlug=_.filter(this.options.mapConfig.layers,function(e){return e.id===i.formState.selectedDatasetId})[0].slug,this.render(this.formState.selectedCategory,!0),t(e.target).parent().prev().prop("checked",!0),t("#selected-category").hide().show(s),t("#category-btns").animate({height:"hide"},s),this.center&&this.$(".drag-marker-instructions, .drag-marker-warning").addClass("is-visuallyhidden")},onClickGeolocate:function(i){var s=this;i.preventDefault();var o=this.options.appView.mapView.map.getBounds().toBBoxString();e.Util.log("USER","map","geolocate",o,this.options.appView.mapView.map.getZoom()),t("#drag-marker-content").addClass("is-visuallyhidden"),t("#geolocating-msg").removeClass("is-visuallyhidden"),this.options.appView.mapView.map.locate().on("locationfound",function(){s.center=s.options.appView.mapView.map.getCenter(),t("#spotlight-place-mask").remove(),t("#drag-marker-content").addClass("is-visuallyhidden")}).on("locationerror",function(){t("#drag-marker-content").removeClass("is-visuallyhidden"),t("#geolocating-msg").addClass("is-visuallyhidden")})},onInputFileChange:function(i){var s,o=this;i.target.files&&i.target.files.length&&(s=i.target.files[0],this.$(".fileinput-name").text(s.name),e.Util.fileToCanvas(s,function(e){e.toBlob(function(s){o.formState.attachmentData={name:t(i.target).attr("name"),blob:s,file:e.toDataURL("image/jpeg")}},"image/jpeg")},{maxWidth:800,maxHeight:800,canvas:!0}))},onBinaryToggle:function(e){var i=this,s=t(e.target).attr("id"),o=t(e.target).val(),n=_.find(this.formState.placeDetail,function(e){return e.category===i.formState.selectedCategory}),a=_.find(n.fields,function(e){return e.name===s}),r=_.find(a.content,function(e){return e.value!=o});t(e.target).val(r.value),t(e.target).next("label").html(r.label)},closePanel:function(){this.center=null,this.resetFormState()},onExpandCategories:function(){var e=400;t("#selected-category").hide(e),t("#category-btns").animate({height:"show"},e)},onSubmit:Gatekeeper.onValidSubmit(function(t){if(!this.center)return this.$(".drag-marker-instructions").addClass("is-visuallyhidden"),this.$(".drag-marker-warning").removeClass("is-visuallyhidden"),this.$el.parent("article").scrollTop(0),void window.scrollTo(0,0);var i,s,o=this,n=this.options.router,a=this.collection[o.formState.selectedDatasetId],r=this.getAttrs(),l=this.$('[name="save-place-btn"]');if(t.preventDefault(),a.add({location_type:this.formState.selectedCategory}),i=a.at(a.length-1),i.set("datasetSlug",o.formState.selectedDatasetSlug),i.set("datasetId",o.formState.selectedDatasetId),o.formState.attachmentData){var c=i.attachmentCollection.find(function(e){return e.get("name")===o.formState.attachmentData.name});_.isUndefined(c)?i.attachmentCollection.add(o.formState.attachmentData):c.set(o.formState.attachmentData)}l.attr("disabled","disabled"),s=new Spinner(e.smallSpinnerOptions).spin(o.$(".form-spinner")[0]),e.Util.log("USER","new-place","submit-place-btn-click"),e.Util.setStickyFields(r,e.Config.survey.items,e.Config.place.items),i.save(r,{success:function(){e.Util.log("USER","new-place","successfully-add-place"),n.navigate("/"+i.get("datasetSlug")+"/"+i.id,{trigger:!0})},error:function(){e.Util.log("USER","new-place","fail-to-add-place")},complete:function(){l.removeAttr("disabled"),s.stop(),o.resetFormState()},wait:!0})})})}(Shareabouts,jQuery,Shareabouts.Util.console);var Shareabouts=Shareabouts||{};!function(e,t){Backbone.Marionette.TemplateCache.prototype.compileTemplate=function(e){return Handlebars.compile(e)},e.PlaceListItemView=Backbone.Marionette.Layout.extend({template:"#place-detail",tagName:"li",className:"clearfix",regions:{support:".support"},modelEvents:{show:"show",hide:"hide",change:"render"},initialize:function(){var t=e.Config.support.submission_type;this.model.submissionSets[t]=this.model.submissionSets[t]||new e.SubmissionCollection(null,{submissionType:t,placeModel:this.model}),this.supportView=new e.SupportView({collection:this.model.submissionSets[e.Config.support.submission_type],supportConfig:e.Config.support,userToken:e.Config.userToken})},onBeforeRender:function(){this.model.attachmentCollection.length>0&&this.model.set("attachments",this.model.attachmentCollection.toJSON())},onRender:function(){this.support.show(this.supportView)},show:function(){this.$el.show()},hide:function(){this.$el.hide()}}),e.PlaceListView=Backbone.Marionette.CompositeView.extend({template:"#place-list",itemView:e.PlaceListItemView,itemViewContainer:".place-list",ui:{searchField:"#list-search",searchForm:".list-search-form",allSorts:".list-sort-menu a",date:".date-sort",surveyCount:".survey-sort",supportCount:".support-sort"},events:{"input @ui.searchField":"handleSearchInput","submit @ui.searchForm":"handleSearchSubmit","click @ui.date":"handleDateSort","click @ui.surveyCount":"handleSurveyCountSort","click @ui.supportCount":"handleSupportCountSort"},initialize:function(t){var i=this;t=t||{},this.collection=new e.PlaceCollection([]),_.each(this.options.placeCollections,function(e){e.on("add",i.addModel,i),e.on("sync",i.onSync,i)}),this.views={},this.sortBy="date",this.collectionFilters=t.filter||{},this.searchTerm=t.term||""},onSync:function(){this.sort()},onAfterItemAdded:function(e){this.views[e.model.cid]=e},addModel:function(e){this.collection.add(e)},renderList:function(){var e=this,i=this.getItemViewContainer(this);i.empty(),this.collection.each(function(t){e.views[t.cid]&&(i.append(e.views[t.cid].$el),e.views[t.cid].supportView.delegateEvents())}),t("#list-container .place-story-bar").remove()},handleSearchInput:function(e){e.preventDefault(),this.search(this.ui.searchField.val())},handleSearchSubmit:function(e){e.preventDefault(),this.search(this.ui.searchField.val())},handleDateSort:function(e){e.preventDefault(),this.sortBy="date",this.sort(),this.updateSortLinks()},handleSurveyCountSort:function(e){e.preventDefault(),this.sortBy="surveyCount",this.sort(),this.updateSortLinks()},handleSupportCountSort:function(e){e.preventDefault(),this.sortBy="supportCount",this.sort(),this.updateSortLinks()},updateSortLinks:function(){this.ui.allSorts.removeClass("is-selected"),this.ui[this.sortBy].addClass("is-selected")},dateSort:function(e,t){return e.get("created_datetime")>t.get("created_datetime")?-1:1},surveyCountSort:function(t,i){var s=t.submissionSets[e.Config.survey.submission_type],o=i.submissionSets[e.Config.survey.submission_type],n=s?s.size():0,a=o?o.size():0;return n===a?t.get("created_datetime")>i.get("created_datetime")?-1:1:n>a?-1:1},supportCountSort:function(t,i){var s=t.submissionSets[e.Config.support.submission_type],o=i.submissionSets[e.Config.support.submission_type],n=s?s.size():0,a=o?o.size():0;return n===a?t.get("created_datetime")>i.get("created_datetime")?-1:1:n>a?-1:1},sort:function(){var e=this.sortBy+"Sort";this.collection.comparator=this[e],this.collection.sort(),this.renderList(),this.search(this.ui.searchField.val())},clearFilters:function(){this.collectionFilters={},this.applyFilters(this.collectionFilters,this.searchTerm)},filter:function(e){_.extend(this.collectionFilters,e),this.applyFilters(this.collectionFilters,this.searchTerm)},search:function(e){this.searchTerm=e,this.applyFilters(this.collectionFilters,this.searchTerm)},applyFilters:function(t,i){var s,o;i=i.toUpperCase(),this.collection.each(function(n){var a,r=function(){n.trigger("show")},l=function(){n.trigger("hide")},c=n.get("location_type"),p=_.find(e.Config.place.place_detail,function(e){return e.category===c});for(o in t){if(s=t[o],_.isFunction(s)&&!s(n))return l();if(!n.get(o)||s.toUpperCase()!==n.get(o).toUpperCase())return l()}for(var u=0;u<p.fields.length;u++)if(o=p.fields[u].name,s=n.get(o),_.isString(s)&&-1!==s.toUpperCase().indexOf(i))return r();return a=n.get("submitter"),!r&&a&&(a.name&&-1!==a.name.toUpperCase().indexOf(i)||a.username&&-1!==a.username.toUpperCase().indexOf(i))?r():(c=e.Config.flavor.place_types[n.get("location_type")],!r&&c&&c.label&&-1!==c.label.toUpperCase().indexOf(i)?r():l())},this)},isVisible:function(){
return this.$el.is(":visible")}})}(Shareabouts,jQuery,Shareabouts.Util.console);var Shareabouts=Shareabouts||{};!function(e,t){e.MapView=Backbone.View.extend({events:{"click .locate-me":"onClickGeolocate"},initialize:function(){var i=this,s=function(){e.Util.log("USER","map","zoom",i.map.getBounds().toBBoxString(),i.map.getZoom())},o=function(){e.Util.log("USER","map","drag",i.map.getBounds().toBBoxString(),i.map.getZoom())};this.map=L.map(i.el,i.options.mapConfig.options),_.each(i.options.mapConfig.layers,function(e){e.loaded=!1}),this.layers={},this.layerViews={},this.places=this.options.places,this.landmarks=this.options.landmarks,i.map.attributionControl.setPrefix(""),i.options.mapConfig.geolocation_enabled&&i.initGeolocation(),i.map.on("dragend",o),t(i.map.zoomControl._zoomInButton).click(s),t(i.map.zoomControl._zoomOutButton).click(s),i.map.on("zoomend",function(s){e.Util.log("APP","zoom",i.map.getZoom()),t(e).trigger("zoomend",[s])}),i.map.on("moveend",function(s){e.Util.log("APP","center-lat",i.map.getCenter().lat),e.Util.log("APP","center-lng",i.map.getCenter().lng),t(e).trigger("mapmoveend",[s])}),i.map.on("dragend",function(i){t(e).trigger("mapdragend",[i])}),_.each(i.places,function(e,t){i.layers[t]=i.getLayerGroups(),i.layerViews[t]={},e.on("reset",i.render,i),e.on("add",i.addLayerView(t),i),e.on("remove",i.removeLayerView(t),i),e.on("userHideModel",i.onUserHideModel(t),i)}),_.each(i.landmarks,function(e,t){i.layers[t]=L.layerGroup(),i.layerViews[t]={},e.on("add",i.addLandmarkLayerView(t),i),e.on("remove",i.removeLandmarkLayerView(t),i)}),t(e).on("visibility",function(e,t,s,o){var n=i.layers[t],a=_.find(i.options.mapConfig.layers,function(e){return e.id===t});a&&!a.loaded&&s&&(i.createLayerFromConfig(a),a.loaded=!0,n=i.layers[t]),o?_.each(i.options.basemapConfigs,function(e){e.id===t?(i.map.addLayer(n),n.bringToBack()):i.layers[e.id]&&i.map.removeLayer(i.layers[e.id])}):n?i.setLayerVisibility(n,s):a.asyncLayerVisibleDefault=s})},onUserHideModel:function(i){return function(s){this.options.placeDetailViews[s.cid].remove(),delete this.options.placeDetailViews[s.cid],this.places[i].remove(s),e.Util.log("APP","panel-state","closed"),t("#spotlight-place-mask").remove(),this.locationTypeFilter?this.options.router.navigate("filter/"+this.locationTypeFilter,{trigger:!0}):this.options.router.navigate("/",{trigger:!0})}},setLayerVisibility:function(e,t){this.map.closePopup(),t&&!this.map.hasLayer(e)&&this.map.addLayer(e),!t&&this.map.hasLayer(e)&&this.map.removeLayer(e)},reverseGeocodeMapCenter:_.debounce(function(){var i=this.map.getCenter();e.Util.MapQuest.reverseGeocode(i,{success:function(i){var s=i.results[0].locations;t(e).trigger("reversegeocode",[s[0]])}})},1e3),initGeolocation:function(){var e=this,t=function(e){var t;switch(e.code){case 0:t="An unknown error occured while locating your position. Please try again.";break;case 1:t="Geolocation is disabled for this page. Please adjust your browser settings.";break;case 2:t="Your location could not be determined. Please try again.";break;case 3:t="It took too long to determine your location. Please try again."}alert(t)},i=function(t){var i;!e.map.options.maxBounds||e.map.options.maxBounds.contains(t.latlng)?e.map.fitBounds(t.bounds):(i="It looks like you're not in a place where we're collecting data. I'm going to leave the map where it is, okay?",alert(i))};this.$(".leaflet-top.leaflet-right").append('<div class="leaflet-control leaflet-bar"><a href="#" class="locate-me"></a></div>'),this.map.on("locationerror",t),this.map.on("locationfound",i),this.options.mapConfig.geolocation_onload&&this.geolocate()},onClickGeolocate:function(t){t.preventDefault(),e.Util.log("USER","map","geolocate",this.map.getBounds().toBBoxString(),this.map.getZoom()),this.geolocate()},geolocate:function(){this.map.locate()},addLandmarkLayerView:function(t){return function(i){this.layerViews[t][i.id]=new e.BasicLayerView({model:i,router:this.options.router,map:this.map,placeTypes:this.options.placeTypes,collectionId:t,layer:this.layers[t],mapView:this})}},removeLandmarkLayerView:function(e){return function(t){this.layerViews[e][t.id].remove(),delete this.layerViews[e][t.id]}},addLayerView:function(t){return function(i){this.layerViews[t][i.cid]=new e.LayerView({model:i,router:this.options.router,map:this.map,layer:this.layers[t],placeTypes:this.options.placeTypes,mapView:this})}},removeLayerView:function(e){return function(t){this.layerViews[e][t.cid].remove(),delete this.layerViews[e][t.cid]}},zoomInOn:function(e){this.map.setView(e,this.options.mapConfig.options.maxZoom||17)},filter:function(e){var t=this;this.locationTypeFilter=e,this.collection.each(function(i){var s=i.get("location_type");s&&s.toUpperCase()===e.toUpperCase()?t.layerViews[i.cid].show():t.layerViews[i.cid].hide()}),_.each(Object.keys(t.landmarks),function(i){t.landmarks[i].each(function(s){var o=s.get("location_type");o&&o.toUpperCase()===e.toUpperCase()?t.layerViews[i][s.id].show():t.layerViews[i][s.id].hide()})})},clearFilter:function(){var e=this;this.locationTypeFilter=null,_.each(this.places,function(t){t.each(function(t){e.layerViews[t.cid]&&e.layerViews[t.cid].render()})}),_.each(this.landmarks,function(t){t.each(function(t){e.layerViews[t.cid]&&e.layerViews[t.cid].render()})})},getLayerGroups:function(){var e=this,t=e.options.cluster;return t?L.markerClusterGroup({iconCreateFunction:function(e){var i=e.getAllChildMarkers(),s=i.length,o=s<t.threshold,n=o?t.class_small:t.class_large,a=o?t.size_small:t.size_large;return L.divIcon({html:s,className:n,iconSize:[a,a]})}}):L.layerGroup()},createLayerFromConfig:function(t){var i,s=this;if(t.type&&"json"===t.type){var o=t.url;t.sources&&(o+="?",t.sources.forEach(function(e){o+=encodeURIComponent(e)+"&"})),i=L.argo(o,t),s.layers[t.id]=i}else t.type&&"esri-feature"===t.type?"all at once"===t.loadStrategy?L.esri.Tasks.query({url:t.url}).ids(function(e,i){for(var o=[],n=0;n<i.length;n+=1e3)L.esri.Tasks.query({url:t.url}).featureIds(i.slice(n,n+1e3)).run(function(e,n){var a=L.argo(n,t);t.popupContent&&curentLayer.bindPopup(function(e){return L.Argo.t(t.popupContent,e.properties)}),o.push(a),o.length===Math.floor(i.length/1e3)+1&&(s.layers[t.id]=L.layerGroup(o))})}):(i=L.esri.featureLayer({url:t.url,style:function(e){return L.Argo.getStyleRule(e,t.rules).style}}),t.popupContent&&i.bindPopup(function(e){return L.Argo.t(t.popupContent,e.properties)}),s.layers[t.id]=i):t.type&&"place"===t.type||t.type&&"landmark"===t.type||(t.type&&"cartodb"===t.type?cartodb.createLayer(s.map,t.url,{legends:!1}).on("done",function(e){s.layers[t.id]=e,t.asyncLayerVisibleDefault&&e.addTo(s.map)}).on("error",function(t){e.Util.log("Cartodb layer creation error:",t)}):t.layers?(i=L.tileLayer.wms(t.url,{layers:t.layers,format:t.format,transparent:t.transparent,version:t.version,crs:L.CRS.EPSG3857,attribution:t.attribution,opacity:t.opacity,fillColor:t.color,weight:t.weight,fillOpacity:t.fillOpacity}),s.layers[t.id]=i):(i=L.tileLayer(t.url,t),s.layers[t.id]=i))}})}(Shareabouts,jQuery,Shareabouts.Util.console);var Shareabouts=Shareabouts||{};!function(e){e.LegendView=Backbone.View.extend({render:function(){var t=_.extend({items:this.options.config.items},e.stickyFieldValues);return this.$el.html(Handlebars.templates.legend(t)),this}})}(Shareabouts,jQuery,Shareabouts.Util.console);var Shareabouts=Shareabouts||{};!function(e,t){e.GISLegendView=Backbone.View.extend({events:{"change .map-legend-basemap-radio":"toggleBasemap","change .map-legend-checkbox":"toggleVisibility","change .map-legend-grouping-checkbox":"toggleHeaderVisibility"},render:function(){var i=_.extend({basemaps:this.options.config.basemaps,groupings:this.options.config.groupings},e.stickyFieldValues);this.$el.html(Handlebars.templates["gis-legend-content"](i)),_.each(this.options.config.groupings,function(i){_.each(i.layers,function(i){t(e).trigger("visibility",[i.id,!!i.visibleDefault])})});var s=_.find(this.options.config.basemaps,function(e){return!!e.visibleDefault});return t(e).trigger("visibility",[s.id,!!s.visibleDefault,!0]),this},toggleVisibility:function(i){var s=t(i.target),o=s.attr("data-layerid"),n=!!s.is(":checked");t(e).trigger("visibility",[o,n])},toggleBasemap:function(i){{var s=t(i.target),o=s.attr("data-layerid"),n=!!s.is(":checked");this.options.config.basemaps}t(e).trigger("visibility",[o,n,!0])},toggleHeaderVisibility:function(s){var o=t(s.target),n=o.attr("id"),a=o.is(":checked"),r=_.find(this.options.config.groupings,function(e){return e.id===n});for(i=0;i<r.layers.length;i++){var l=r.layers[i];t(e).trigger("visibility",[l.id,a]),t("#map-"+l.id).prop("checked",a)}}})}(Shareabouts,jQuery,Shareabouts.Util.console);var Shareabouts=Shareabouts||{};!function(e){e.SidebarView=Backbone.View.extend({initialize:function(){},render:function(){var t=this,i={config:this.options.sidebarConfig};this.$el.html(Handlebars.templates.sidebar(i)),_.each(this.options.sidebarConfig.panels,function(i){"ticker"!=i.id&&new e[i.view]({el:"#"+i.id,mapView:t.options.mapView,config:i}).render()}),t.sidebar=L.control.sidebar("sidebar",{position:"left"}),t.sidebar.addTo(this.options.mapView)}})}(Shareabouts,jQuery,Shareabouts.Util.console);var Shareabouts=Shareabouts||{};!function(e,t,i){e.App=Backbone.Router.extend({routes:{"":"viewMap","filter/:locationtype":"filterMap","page/:slug":"viewPage",":dataset/:id":"viewPlace","new":"newPlace",":dataset/:id/response/:response_id":"viewPlace",":dataset/:id/edit":"editPlace",list:"showList",":id":"viewLandmark",":zoom/:lat/:lng":"viewMap"},initialize:function(t){var s,o,n=this,a={};this.places={},this.activities={},this.landmarks={},e.PlaceModel.prototype.getLoggingDetails=function(){return this.id},e.LandmarkModel.prototype.getLoggingDetails=function(){return this.id},e.PlaceModel.prototype.validate=function(t){var s=t.location_type,o=_.map(e.Config.placeTypes,function(e,t){return t});return _.contains(o,s)?void 0:(i.warn(s+" is not supported."),s+" is not supported.")},this.bind("route",function(){e.Util.log("ROUTE",n.getCurrentPath())}),o=this.getFilteredRoutes(),this.bind("route",function(e){_.contains(o,e)||this.clearLocationTypeFilter()},this),this.loading=!0,a.landmarks=t.mapConfig.layers.filter(function(e){return e.type&&"landmark"===e.type}),_.each(a.landmarks,function(t){var i=t.url+"?";t.sources.forEach(function(e){i+=encodeURIComponent(e)+"&"});var s=new e.LandmarkCollection([],{url:i});n.landmarks[t.id]=s}),a.places=t.mapConfig.layers.filter(function(e){return e.type&&"place"===e.type}),_.each(a.places,function(t){var i=new e.PlaceCollection([],{url:"/dataset/"+t.id+"/places"});n.places[t.id]=i}),_.each(a.places,function(t){var i=new e.ActionCollection([],{url:"/dataset/"+t.id+"/actions"});n.activities[t.id]=i}),this.appView=new e.AppView({el:"body",activities:this.activities,places:this.places,landmarks:this.landmarks,datasetConfigs:a,config:t.config,defaultPlaceTypeName:t.defaultPlaceTypeName,placeTypes:t.placeTypes,cluster:t.cluster,surveyConfig:t.surveyConfig,supportConfig:t.supportConfig,pagesConfig:t.pagesConfig,mapConfig:t.mapConfig,storyConfig:t.storyConfig,placeConfig:t.placeConfig,sidebarConfig:t.sidebarConfig,activityConfig:t.activityConfig,userToken:t.userToken,router:this});var r={pushState:!0};t.defaultPlaceTypeName&&(r.root="/"+t.defaultPlaceTypeName+"/"),Backbone.history.start(r),""===Backbone.history.getFragment()&&(s=e.Util.findPageConfig(t.pagesConfig,{start_page:!0}),s&&s.slug&&this.navigate("page/"+s.slug,{trigger:!0})),this.loading=!1},getCurrentPath:function(){var e=Backbone.history.root,t=Backbone.history.fragment;return e+t},viewMap:function(e,t,i){this.appView.mapView.locationTypeFilter&&this.navigate("/filter/"+this.appView.mapView.locationTypeFilter,{trigger:!1}),this.appView.viewMap(e,t,i),this.appView.mapView.clearFilter()},newPlace:function(){this.appView.newPlace()},viewLandmark:function(e){this.appView.viewLandmark(e,{zoom:this.loading})},viewPlace:function(e,t,i){this.appView.viewPlace(e,t,i,this.loading)},editPlace:function(){},viewPage:function(e){this.appView.viewPage(e)},showList:function(){this.appView.showListView()},isMapRoute:function(e){return""===e||-1===e.indexOf("place")&&-1===e.indexOf("page")&&-1===e.indexOf("list")},getFilteredRoutes:function(){return["filterMap","viewPlace","showList","viewMap"]},clearLocationTypeFilter:function(){this.setLocationTypeFilter("all")},setLocationTypeFilter:function(i){var s=t("#current-filter-type");0===s.length&&(s=t('<div id="current-filter-type"/>').insertAfter(t(".menu-item-filter-type > a:first-child")));var o,n;e.Config.pages&&(o=_.findWhere(e.Config.pages,{slug:"filter-type"})),o&&(n=_.findWhere(o.pages,{url:"/filter/"+i})),"all"!==i?(this.appView.mapView.filter(i),this.appView.listView&&this.appView.listView.filter({location_type:i}),n&&s.removeClass().addClass(i).html(n.title)):(this.appView.mapView.clearFilter(),this.appView.listView&&this.appView.listView.clearFilters(),s.removeClass().addClass("unfiltered").empty())},filterMap:function(e){this.setLocationTypeFilter(e),"all"===e&&(this.appView.listView&&this.appView.listView.isVisible()?this.navigate("/list",{trigger:!1}):this.navigate("/",{trigger:!1}))}})}(Shareabouts,jQuery,Shareabouts.Util.console);